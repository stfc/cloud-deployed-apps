stfc-cloud-openstack-cluster:
  openstack-cluster:
    addons:
      monitoring:
        enabled: true
        lokiStack:
          enabled: false
        kubePrometheusStack:
          release:
            values:
              alertmanager:
                config:
                  global:
                    resolve_timeout: 5m
                    opsgenie_api_url: 'https://api.opsgenie.com/'

                  route:
                    # we need a null reciever to workaround azimuth addon enforced defaults 
                    # null reciever just ignores incoming values, then forwarded onto child routes
                    # every alert needs a route - even ones we're ignoring - hence null receiver for ignoring alerts
                    # https://github.com/azimuth-cloud/capi-helm-charts/blob/main/charts/cluster-addons/templates/monitoring/kube-prometheus-stack.yaml#L41-L44
                    receiver: "null"

                    # all child routes pick will use these rules

                    # wait time to pick up any alerts before alertmanager sends off alerts
                    group_wait: 30s
                    # wait time before sending another different group of alerts after one has already been sent
                    group_interval: 5m
                    # wait time before repeating the same group of alerts if the same group of alerts are still firing
                    repeat_interval: 2h
                    # only fire alerts in active office hours
                    active_time_intervals:
                      - officehours
                    
                    # child routes
                    routes:

                      # mute watchdog alert
                      #   - this should always be firing
                      #   - if this shows up on the alertmanager UI it means our monitoring stack is working and alerts are routing correctly

                      # mute infoinhibitor alert
                      #   - not useful by itself
                      #   - if this is firing, we're suppressing severity=info alerts
                      #   - infoinhibitor rules should be automatically configured  
                      #   Infoinhibitor prevents occassional blips from triggering a full-blown alert - like CPUThrottlingHigh 
                      #   - if CPUThrottlingHigh fires on its own, it could just be noise - infoinhibitor alert picks this up and fires, we ignore it
                      #   - if CPUThrottlingHIgh fires in conjunction with other alerts in the same namespace - its probably serious, so infoinhibitor is turned off and each alert fires as normal
                      #   - this is all just to prevent noise in the alert queue

                      # Route 0: ignore Watchdog and InfoInhibitor alerts - clears up alert queue
                      # Only informational - we can see these in alertmanager for info but we don't need to see them in the alert queue
                      - matchers:
                          - alertname=~"Watchdog|InfoInhibitor" 
                        continue: false

                      # Route 1: alerts WITH namespace label - group by namespace
                      - matchers:
                          - namespace=~".+"
                          - alertname!="Watchdog|InfoInhibitor" 
                        group_by: ['severity', 'namespace']
                        receiver: 'with-namespace-receiver'
                        continue: false

                      # Route 2: alerts WITHOUT namespace label - group by alertname
                      - matchers:
                          - namespace=""
                          - alertname!="Watchdog|InfoInhibitor" 
                        receiver: "default-receiver"
                        group_by: ['severity', 'alertname']

                  inhibit_rules:
                    # mute warning/info alerts on same service if a higher level alert is firing in the same namespace - less noise
                    - source_matchers:
                        - severity = "critical"
                      target_matchers:
                        - severity = "warning"
                      equal: ['namespace']
                    - source_matchers:
                        - severity = "critical|warning"
                      target_matchers:
                        - severity = "info"
                      equal: ['namespace']

                  time_intervals:
                    - name: officehours
                      time_intervals:
                        - times:
                            - start_time: 08:30
                              end_time: 17:00
                          weekdays: ["monday:friday"]
                          location: "Europe/London"

                  receivers:
                    - name: "null"
                    - name: default-receiver
                      opsgenie_configs:
                        - send_resolved: true
                          message: >- 
                            {%- raw %}
                            {{ .Status | toUpper }}{{ if eq .Status "firing" }} [{{.CommonLabels.env}}/{{ .CommonLabels.cluster }}: {{ .CommonLabels.severity | toUpper }}] {{ .Alerts.Firing | len }}{{ end }} {{.CommonLabels.alertname}} alert(s)
                            {%- endraw %}
                          description: >-
                              {%- raw %}
                              {{ if gt (len .Alerts.Firing) 0 -}}
                              Alerts Firing:
                              {{ template "__text_alert_list" .Alerts.Firing }}
                              {{- end }}
                              {%- endraw %}
                          tags: >- 
                              {%- raw %}
                              {{- if eq .CommonLabels.env "prod" -}}stfc-production{{- else -}}stfc-development{{- end }}
                              {%- endraw %}
                          entity: >-
                              {%- raw %}
                              {{- if eq .CommonLabels.env "prod" -}}stfc-production{{- else -}}stfc-development{{- end }}
                              {%- endraw %}
                          

                    - name: with-namespace-receiver
                      opsgenie_configs:
                        - send_resolved: true
                          message: >- 
                            {%- raw %}
                            {{ .Status | toUpper }}{{ if eq .Status "firing" }} [{{.CommonLabels.env}}/{{ .CommonLabels.cluster }}: {{ .CommonLabels.severity | toUpper }}] {{ .Alerts.Firing | len }}{{ end }} alert(s) for {{.CommonLabels.namespace}}
                            {%- endraw %}
                          description: >-
                            {%- raw %}
                            {{ if gt (len .Alerts.Firing) 0 -}}
                            Alerts Firing:
                            {{ template "__text_alert_list" .Alerts.Firing }}
                            {{- end }}
                            {%- endraw %}
                          tags: >- 
                            {%- raw %}
                            {{- if eq .CommonLabels.env "prod" -}}stfc-production{{- else -}}stfc-development{{- end }}
                            {%- endraw %}
                          entity: >-
                            {%- raw %}
                            {{- if eq .CommonLabels.env "prod" -}}stfc-production{{- else -}}stfc-development{{- end }}
                            {%- endraw %}
                          
                  templates:
                    - "/etc/alertmanager/config/*.tmpl"
